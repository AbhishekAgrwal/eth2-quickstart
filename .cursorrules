# Ethereum Node Setup - Agent Context

## Documentation Structure
This project contains comprehensive documentation organized in the `docs/` folder:

### Core Documentation
- `docs/README.md` - Main project overview and quickstart guide
- `docs/SCRIPTS.md` - Detailed script reference and usage
- `docs/WORKFLOW.md` - Setup workflow and process documentation
- `docs/GLOSSARY.md` - Technical terminology and definitions

### Configuration & Architecture
- `docs/CONFIGURATION_GUIDE.md` - Configuration architecture and conventions
- `docs/REFACTORING_CONFIGS.md` - Configuration refactoring details
- `docs/REFACTORING_SUMMARY.md` - Overall refactoring summary and changes

### Development & Testing
- `docs/SHELL_SCRIPTING_BEST_PRACTICES_AND_LINTING_GUIDE.md` - Shell scripting standards
- `docs/SHELL_SCRIPT_TEST_RESULTS.md` - Test results and validation
- `docs/COMPREHENSIVE_SCRIPT_TESTING_REPORT.md` - Comprehensive testing documentation

### Project Management
- `docs/CONSOLIDATED_PR.md` - Pull request consolidation details
- `docs/FINAL_VERIFICATION.md` - Final verification and validation
- `docs/COMMIT_MESSAGES.md` - Commit message conventions
- `docs/progress.md` - Development progress tracking

## Key Architecture Patterns
- **Centralized Configuration**: All variables in `exports.sh`
- **Template + Custom Pattern**: Base configs + user customizations
- **Common Functions**: Shared utilities in `lib/common_functions.sh`
- **Client Diversity**: Support for 5 execution + 6 consensus clients

## Agent Guidelines
When working with this codebase:
1. Follow shell scripting best practices from `docs/SHELL_SCRIPTING_BEST_PRACTICES_AND_LINTING_GUIDE.md`
2. Maintain configuration consistency per `docs/CONFIGURATION_GUIDE.md`
3. Use common functions from `lib/common_functions.sh` to avoid duplication
4. Reference appropriate documentation for context and standards

## Common Functions Library
The `lib/common_functions.sh` contains 35 centralized functions for:
- **Logging**: `log_info()`, `log_warn()`, `log_error()`
- **Installation**: `log_installation_start()`, `log_installation_complete()`
- **Directory Management**: `get_script_directories()`, `ensure_directory()`, `create_temp_config_dir()`
- **Configuration**: `merge_client_config()` (supports JSON, YAML, TOML)
- **Security**: `setup_secure_user()`, `configure_ssh()`, `setup_fail2ban()`
- **System Services**: `create_systemd_service()`, `enable_and_start_systemd_service()`
- **File Operations**: `download_file()`, `secure_download()`
- **System Checks**: `check_system_requirements()`, `check_system_compatibility()`

## Refactoring Status
- ✅ **REFACTORING COMPLETE**: All 35 functions implemented and tested
- ✅ **Code Duplication**: Reduced by ~40% through centralized functions
- ✅ **Shellcheck Compliance**: 100% compliance achieved
- ✅ **Architecture**: Centralized configuration and function patterns maintained

## Code Review Process

### Required Review Passes (Minimum 3, Maximum 5)

**Pass 1: Functionality Verification**
- Verify all function calls work correctly
- Check for missing functions that are being called
- Ensure no broken function references
- Test that all added functions are properly defined

**Pass 2: Architecture Compliance** 
- Verify scripts run with correct user privileges (root vs non-root)
- Check that changes align with codebase architecture
- Ensure security functions are properly integrated
- Validate that client install scripts run as non-root users

**Pass 3: Code Quality**
- Remove duplicate functions
- Verify function signatures match usage
- Check for unused functions that can be removed
- Ensure consistent error handling patterns

**Pass 4: Edge Cases (if issues found in Pass 3)**
- Test critical paths and error conditions
- Verify all function parameters are handled correctly
- Check for any remaining hardcoded patterns

**Pass 5: Final Validation (if issues found in Pass 4)**
- Comprehensive end-to-end validation
- Final cleanup and documentation
- Verify all changes follow security best practices

### Review Completion Criteria
- All function calls work without errors
- No missing or broken function references
- Architecture compliance maintained (root vs non-root execution)
- Code quality standards met
- No functionality removed or broken

## Rule Enforcement Mechanisms

### Mandatory Compliance Checks
Before any code changes are considered complete, the following must be verified:

1. **Function Reference Validation**
   - All function calls must reference existing functions in `lib/common_functions.sh`
   - Use `grep` to verify function definitions exist before calling them
   - Replace any hardcoded patterns with centralized function calls

2. **Architecture Pattern Compliance**
   - Install scripts MUST call `require_root()` for privileged operations
   - Non-install scripts MUST NOT call `require_root()`
   - All scripts MUST call `get_script_directories()` for path management
   - Use `log_installation_start()` and `log_installation_complete()` for install scripts

3. **Security Function Integration**
   - Security functions MUST be called in `run_1.sh` for comprehensive setup
   - All configuration files MUST use `secure_config_files()` for proper permissions
   - Network security functions MUST be applied via `apply_network_security()`

4. **Code Quality Enforcement**
   - Run `shellcheck` on all modified scripts before committing
   - Remove any duplicate or unused functions
   - Ensure consistent error handling using `log_error()` and proper exit codes
   - Verify all function signatures match their usage patterns

### Validation Requirements

**Pre-Commit Validation Checklist:**
- [ ] All function calls verified to exist in `lib/common_functions.sh`
- [ ] Script execution privileges correctly implemented (root vs non-root)
- [ ] Security functions properly integrated where required
- [ ] Shellcheck compliance achieved (0 warnings/errors)
- [ ] No duplicate or unused functions remain
- [ ] Error handling patterns consistent across all modified files
- [ ] Documentation updated to reflect any new functions or changes

**Automated Validation Commands:**
```bash
# Verify function references
grep -r "function_name" install/ | grep -v "lib/common_functions.sh"

# Check shellcheck compliance
find install/ -name "*.sh" -exec shellcheck {} \;

# Verify root privilege usage
grep -r "require_root" install/ | wc -l  # Should match expected count
```

### Rule Violation Prevention

**Common Violations to Avoid:**
1. **Missing Function Calls** - Always verify functions exist before calling
2. **Incorrect Privilege Usage** - Install scripts need root, others don't
3. **Hardcoded Patterns** - Use centralized functions instead of duplicating code
4. **Inconsistent Error Handling** - Always use `log_error()` and proper exit codes
5. **Security Function Neglect** - Ensure security functions are properly integrated

**Enforcement Actions:**
- If any rule violation is detected, the code change MUST be rejected
- All violations MUST be fixed before proceeding to the next review pass
- Additional review passes MUST be performed until all rules are satisfied

## Consistency Maintenance Guidelines

### Code Pattern Standards
1. **Script Structure** - All scripts MUST follow the established pattern:
   ```bash
   #!/bin/bash
   source ../../exports.sh
   source ../../lib/common_functions.sh
   get_script_directories
   # [require_root for install scripts only]
   log_installation_start "ComponentName"
   # [script logic using common functions]
   log_installation_complete "ComponentName" "service_name"
   ```

2. **Function Usage** - Always prefer common functions over custom implementations:
   - Use `log_info()`, `log_warn()`, `log_error()` for all logging
   - Use `secure_download()` instead of `wget` or `curl` directly
   - Use `ensure_directory()` for directory creation
   - Use `create_systemd_service()` for service management

3. **Error Handling** - Consistent error handling pattern:
   ```bash
   if ! function_call; then
       log_error "Descriptive error message"
       exit 1
   fi
   ```

### Documentation Requirements
- All new functions MUST be documented in the appropriate section of this file
- Function usage examples MUST be provided in comments
- Architecture changes MUST be reflected in the relevant documentation files
- Security implications MUST be documented and validated

### Quality Assurance Process
1. **Before Making Changes** - Read and understand existing patterns
2. **During Development** - Follow established patterns and use common functions
3. **After Changes** - Run all validation checks and review passes
4. **Before Committing** - Ensure all rules are satisfied and documentation is updated

This comprehensive rule set ensures consistent, maintainable, and secure code across the entire Ethereum node setup project.