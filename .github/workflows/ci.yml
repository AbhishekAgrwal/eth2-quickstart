name: CI - Docker Integration Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Allow manual trigger for testing

jobs:
  docker-integration:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build test Docker image
      run: |
        docker build -t eth-node-test -f test/Dockerfile .
        
    - name: Run lint tests in Docker
      run: |
        docker run --rm eth-node-test /workspace/test/run_tests.sh --lint-only
        
    - name: Run unit tests in Docker
      run: |
        docker run --rm --privileged \
          -e USE_MOCKS=false \
          eth-node-test /workspace/test/docker_test.sh
          
    - name: Test run_1.sh (Phase 1 - Structure Validation)
      run: |
        # Structural validation - syntax, functions, SSH safety, etc.
        docker run --rm --privileged \
          --user root \
          -e DEBIAN_FRONTEND=noninteractive \
          eth-node-test /workspace/test/ci_test_run_1.sh

    - name: Test run_1.sh E2E (Phase 1 - Actual Execution)
      timeout-minutes: 5
      run: |
        # Actually runs run_1.sh and verifies results (systemd + openssh required)
        # Uses tmpfs/cgroupns for systemd on GitHub Actions (cgroup v2)
        SKIP_BUILD=true ./test/run_run_1_e2e.sh

    - name: Test run_2.sh (Phase 2 - Client Installation)
      run: |
        # Run run_2.sh inside Docker with default selections
        # Inputs: 1=MEV-Boost, 2=Default clients (Geth+Prysm)
        # Full E2E test takes ~5-7 minutes
        docker run --rm --privileged \
          -e DEBIAN_FRONTEND=noninteractive \
          eth-node-test /workspace/test/ci_test_run_2.sh

  shellcheck:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run shellcheck
      run: |
        sudo apt-get update && sudo apt-get install -y shellcheck
        
        echo "Running shellcheck on all shell scripts..."
        find . -name "*.sh" -type f | while read -r script; do
          echo "Checking $script..."
          if ! shellcheck -x --exclude=SC2317,SC1091,SC1090,SC2034,SC2031,SC2181 "$script"; then
            echo "❌ Shellcheck failed for $script"
            exit 1
          fi
        done
        echo "✅ All scripts passed shellcheck!"
